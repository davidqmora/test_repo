@using WebUI.Model
@using Microsoft.Identity.Web
<MudForm>
    
    @if (RequiredProperties is { PreferredEmail: true })
    {
        <MudTextField T="string"
                      @bind-Value="@userProfile.PreferredEmail"
                      Label="Preferred Email"
                      Required="true"
                      RequiredError="Preferred Email is required."/>
    }
    @if (RequiredProperties is { SocialHandle: true })
    {
        <MudTextField T="string"
                      @bind-Value="@userProfile.SocialHandle"
                      Label="Social Handle"
                      Required="true"
                      RequiredError="Social Handle is required."/>
    }
    @if (RequiredProperties is { CountryOrRegion: true })
    {
        <MudTextField T="string"
                      @bind-Value="@userProfile.CountryOrRegion"
                      Label="Country/Region"
                      Required="true"
                      RequiredError="Country Or Region is required."/>
    }
    @if (RequiredProperties is { AgeOfIndemnity: true })
    {
        <MudCheckBox @bind-Value="@userProfile.AgeOfIndemnity"
                     Label="Age Of Indemnity"
                     Required="true"
                     RequiredError="Age Of Indemnity is required."/>
    }
    @if (RequiredProperties is { TermsOfUseAgreement: true })
    {
        <MudCheckBox Label="Terms Of Use Agreement"
                     T="bool"
                     @ref="tosaControl"
                     Required="true"
                     RequiredError="Terms Of Use Agreement is required."
                     CheckedChanged="@HandleAgeOfIndemnityClick"/>
        <MudButton Variant="Variant.Text"
                   Color="Color.Primary"
                   OnClick="@SeeTermsOfUse">
            See Terms
        </MudButton>
    }
    @if (arePropertiesRequired)
    {
        <MudStack Row
                  Spacing="4"
                  Class="mt-4">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       DisableElevation="true"
                       OnClick="@HandleSubmit">
                Submit
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Secondary"
                       DisableElevation="true"
                       OnClick="@HandleReset">
                Reset
            </MudButton>
        </MudStack>
    }
    else
    {
        <MudText Typo="Typo.body1">
            There are no properties required.
        </MudText>
    }
</MudForm>
<MudPaper>
    @submissionResponse
</MudPaper>


@inject ILocalAccountService LocalAccountService
@inject MicrosoftIdentityConsentAndConditionalAccessHandler ConsentHandler

@code {
    [Parameter] public RequiredProperties? RequiredProperties { get; set; }
    [Parameter] public EventCallback OnTouRequested { get; set; }

    private UserProfile userProfile = new();

    private string? submissionResponse;
    private bool arePropertiesRequired;
    private MudCheckBox<bool>? tosaControl;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (RequiredProperties is null)
        {
            arePropertiesRequired = false;
            return;
        }
        
        arePropertiesRequired = RequiredProperties.PreferredEmail || RequiredProperties.SocialHandle ||
                                RequiredProperties.CountryOrRegion || RequiredProperties.AgeOfIndemnity ||
                                RequiredProperties.PreferredEmail || RequiredProperties.TermsOfUseAgreement;
    }

    private async Task HandleSubmit()
    {
        submissionResponse = null;
        StateHasChanged();


        var response = await LocalAccountService.UpdateProfile(userProfile, CancellationToken.None);
        submissionResponse = response.IsSuccessStatusCode ? "Accepted" : response.ReasonPhrase;
    }

    private void HandleReset()
    {
        userProfile = new UserProfile();
        if (tosaControl != null)
        {
            tosaControl.Value = false;
        }
    }

    private void HandleAgeOfIndemnityClick(bool isChecked)
    {
        userProfile.TermsOfUseAgreement = isChecked ? DateTime.Now : null;
    }

    private void SeeTermsOfUse()
    {
        OnTouRequested.InvokeAsync();
    }

}